DESTDIR = $DESTDIR
MKSHELL = rc
CC = cc

TARGS = ddate slogans

SLOGANS = \
	ddata/slogans/discordian \
	ddata/slogans/illuminati \
	ddata/slogans/miscellaneous \
	ddata/slogans/neologisms \
	ddata/slogans/subgenius \
	@EXTRASLOGANS@

# No -Werror for now.
CFLAGS = \
	-Werror -g -ggdb -std=gnu11 \
	-O2 -fPIE -march=native -D_FORTIFY_SOURCE=2 \
	-fstack-protector-strong --param=ssp-buffer-size=1 -flto \
	-fsanitize=undefined -fsanitize-trap=undefined \
	-DPREFIX="$PREFIX" -DDATADIR="$DATADIR" \
	`{pkg-config --cflags glew glfw3 libcurl sqlite3} \
	$CFLAGS

LDFLAGS = -Wl,-z,relro,-z,now,--build-id -pie \
	`{pkg-config --libs glew glfw3 libcurl sqlite3} \
	$LDFLAGS

all:V: $TARGS

slogans: $SLOGANS
	cat $prereq > $target

# It has to have a little sleep at the end because otherwise
# it's too fast and thinks it needs to go again
ddate:Q: src/bob.o src/convert.o src/ddate.o src/fmt.o src/slogans.o src/tibs.o src/util.o
	echo $CC -o $target $prereq
	$CC $CFLAGS $LDFLAGS -o $target $prereq
	sleep 1; touch $target

src/%.o:Q: src/%.c
	echo $CC -c -o $target src/$stem.c
	$CC $CFLAGS -c -o $target src/$stem.c

src/bob.o: src/bob.h
src/convert.o: src/convert.h src/ddate.h src/tibs.h
src/ddate.o: src/ddate.h
src/fmt.o: src/bob.h src/ddate.h src/fmt.h src/slogans.h
src/slogans.o: src/slogans.h src/util.h
src/tibs.o: src/tibs.h
src/util.o: src/util.h

install:V: all
	install -D ddate $DESTDIR$BINDIR/ddate
	install -D -m 644 slogans $DESTDIR$DATADIR/ddate/slogans
	install -D -m 644 doc/ddate.1 $DESTDIR$MANDIR/man1/ddate.1
	install -D -m 644 ddata/slogans/README $DESTDIR$DOCDIR/ddate/slogans
	install -m 644 doc/index doc/versions README.md \
			$DESTDIR$DOCDIR/ddate

# Honestly, you shouldn't do this.
# You ought to have packaged it using your distro's packaging tools.
uninstall:V:
	rm -f $DESTDIR$BINDIR/ddate \
		$DESTDIR$DATADIR/ddate/slogans \
		$DESTDIR$MANDIR/man1/ddate.1 \
		$DESTDIR$DOCDIR/ddate/slogans \
		$DESTDIR$DOCDIR/ddate/*
	rmdir $DESTDIR$DATADIR/ddate \
		$DESTDIR$DOCDIR/ddate

clean:V:
	rm -f $TARGS src/*.o

nuke:V: clean
	rm -f mkfile
