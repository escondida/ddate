#!/bin/sh
# Based on the official example for getopt(1) from util-linux
# /usr/share/doc/util-linux/getopt/getopt-parse.bash

bob=slack
slogans=""

TEMP=$(getopt -o 'c:d' --long 'cc,discomBOBulate' -n 'configure' -- "$@")

if [ $? -ne 0 ]; then
	echo 'Terminating...' >&2
	exit 1
fi

# Note the quotes around "$TEMP": they are essential!
eval set -- "$TEMP"
unset TEMP

while true; do
	case "$1" in
		-c | --cc)
			CC=$2
			shift 2
			continue
		;;
		-d | --discomBOBulate)
			unset bob
			shift
			continue
		;;
		--)
			shift
			break
		;;
		*)
			echo 'Usage: configure [-cd]' >&2
			exit 1
		;;
	esac
done

system=$(uname)

if [ -z "$CC" ]; then
	CC=cc
elif [ "$CC" = clang ]; then
	# -Wno-disabled-macro-expansion: warns on fprintf of all things
	CFLAGS="$CFLAGS -Weverything -fno-diagnostics-color -fsanitize-trap=undefined -Wno-disabled-macro-expansion"
fi

echo Using c compiler $CC

if [ "$system" = Linux ]; then
	echo Found operating system Linux
	slogans=ddata/slogans/linux
elif [ "$system" = darwin ]; then
	echo Found operating system Apple
	slogans=ddata/slogans/apple
fi

if [ -n "$bob" ]; then
	echo 'Praising "Bob"'
	CFLAGS="$CFLAGS -DPRAISE_BOB"
	slogans="$slogans ddata/slogans/subgenius"
else
	echo 'Killing "Bob"'
	CFLAGS="$CFLAGS -DKILL_BOB"
fi

sed -e "s,@EXTRASLOGANS@,$slogans," \
	-e "s,CFLAGS =,CFLAGS = $CFLAGS," \
	-e "s,CC = cc,CC = $CC," \
	mkfile.in > mkfile
